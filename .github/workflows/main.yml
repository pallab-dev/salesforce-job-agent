name: developer AI Job Agent + Email

on:
  schedule:
    - cron: "0 */8 * * *"   # every 8 hours
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Run AI Job Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: |
          python - << 'EOF'
          import requests, os, smtplib, json

          GROQ_API_KEY = os.getenv("GROQ_API_KEY")
          EMAIL_USER = os.getenv("EMAIL_USER")
          EMAIL_PASS = os.getenv("EMAIL_PASS")

          # Fetch remote jobs
          jobs = requests.get("https://remoteok.com/api").json()[1:]
          sf_jobs = [j for j in jobs if "developer" in j["position"].lower()]

          if not sf_jobs:
              print("No developer jobs found.")
              exit()

          # Prepare smaller job data
          sf_jobs_small = [
              {
                  "title": j.get("position"),
                  "company": j.get("company"),
                  "url": j.get("url")
              }
              for j in sf_jobs[:10]
          ]
          
          prompt = f"""
          Filter only developer roles with 6+ years experience, remote global.
          Return relevant jobs in bullet points with title, company, and URL.
          Do NOT include any code. Output only bullet points.

          Jobs:
          {sf_jobs_small}
          """
          
          # Call Groq API
          response = requests.post(
              "https://api.groq.com/openai/v1/chat/completions",
              headers={
                  "Authorization": f"Bearer {GROQ_API_KEY}",
                  "Content-Type": "application/json"
              },
              json={
                  "model": "llama-3.1-8b-instant",
                  "messages": [
                      {"role": "user", "content": prompt}
                  ],
                  "temperature": 0.3
              }
          )
          
          data = response.json()
          
          print("GROQ RAW RESPONSE:", data)
          
          if "error" in data:
              print("Groq Error:", data["error"])
              exit(1)
          
          if "choices" not in data:
              print("Unexpected Groq response:", data)
              exit(1)
          
          result = data["choices"][0]["message"]["content"]
          import html
          result = html.unescape(result)

          # Send Email
          # --- Email credentials cleanup ---
          from email.message import EmailMessage

          # Build UTF-8 email properly
          email_msg = EmailMessage()
          email_msg["Subject"] = "New Developer Remote Jobs Found"
          email_msg["From"] = EMAIL_USER
          email_msg["To"] = EMAIL_USER
          email_msg.set_content(result, charset="utf-8")
          
          server = smtplib.SMTP("smtp.gmail.com", 587)
          server.ehlo()
          server.starttls()
          server.ehlo()
          server.login(EMAIL_USER, EMAIL_PASS)
          server.send_message(email_msg)
          server.quit()
          
          print("Email sent successfully!")
          EOF
