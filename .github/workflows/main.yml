name: developer AI Job Agent + Email

on:
  schedule:
    - cron: "0 */8 * * *"   # every 8 hours
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Run AI Job Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: |
          python - << 'EOF'
          import os, json, re, html, smtplib
          import requests
          from email.message import EmailMessage
        
          GROQ_API_KEY = os.getenv("GROQ_API_KEY") or ""
          EMAIL_USER = (os.getenv("EMAIL_USER") or "").strip()
          EMAIL_PASS = (os.getenv("EMAIL_PASS") or "").strip().replace(" ", "")  # you already removed spaces, this keeps it safe
        
          def clean_llm_output(text: str) -> str:
              text = html.unescape(text or "")
        
              # Remove code fences if any
              text = re.sub(r"```.*?```", "", text, flags=re.DOTALL)
        
              # If model returned NONE exactly
              if text.strip() == "NONE":
                  return "NONE"
        
              # Keep only bullet-like lines
              lines = []
              for line in text.splitlines():
                  line = line.strip()
                  if line.startswith(("•", "-", "*")):
                      line = re.sub(r"^[•*]\s*", "- ", line)  # normalize bullets
                      lines.append(line)
        
              if not lines:
                  return "NONE"
        
              return "\n".join(lines[:8])
        
          # 1) Fetch remote jobs
          resp = requests.get("https://remoteok.com/api", timeout=30)
          resp.raise_for_status()
          jobs = resp.json()[1:]
        
          dev_jobs = [j for j in jobs if "developer" in (j.get("position") or "").lower()]
        
          if not dev_jobs:
              print("No developer jobs found.")
              raise SystemExit(0)
        
          # 2) Prepare smaller job data (keep prompt small)
          jobs_for_llm = [
              {
                  "title": j.get("position"),
                  "company": j.get("company"),
                  "url": j.get("url"),
                  "snippet": (j.get("description") or "")[:250],
              }
              for j in dev_jobs[:15]
          ]
        
          prompt = f"""
          You are a job alert bot. Follow instructions EXACTLY.
        
          User preference:
          - Only REMOTE roles.
          - Senior roles (6+ years): Senior / Lead / Staff / Principal / Architect.
          - Reject internships, junior, entry-level.
        
          Output rules (MANDATORY):
          - Output ONLY bullet points.
          - Each bullet must be exactly: "- <Title> — <Company> — <URL>"
          - Max 8 bullets.
          - NO code. NO explanations. NO markdown fences.
          - If none match, output exactly: NONE
        
          Jobs:
          {jobs_for_llm}
          """
        
          # 3) Call Groq
          response = requests.post(
              "https://api.groq.com/openai/v1/chat/completions",
              headers={
                  "Authorization": f"Bearer {GROQ_API_KEY}",
                  "Content-Type": "application/json"
              },
              json={
                  "model": "llama-3.1-8b-instant",
                  "messages": [{"role": "user", "content": prompt}],
                  "temperature": 0.1
              },
              timeout=60
          )
        
          data = response.json()
          print("GROQ RAW RESPONSE keys:", list(data.keys()))
        
          if "error" in data:
              print("Groq Error:", data["error"])
              raise SystemExit(1)
        
          if "choices" not in data:
              print("Unexpected Groq response:", data)
              raise SystemExit(1)
        
          result = data["choices"][0]["message"]["content"]
          result = clean_llm_output(result)
        
          if result == "NONE":
              print("Model found no relevant jobs. Skipping email.")
              raise SystemExit(0)
        
          # 4) Send email (UTF-8 safe)
          email_msg = EmailMessage()
          email_msg["Subject"] = "New Developer Remote Jobs Found"
          email_msg["From"] = EMAIL_USER
          email_msg["To"] = EMAIL_USER
          email_msg.set_content(result, charset="utf-8")
        
          server = smtplib.SMTP("smtp.gmail.com", 587)
          server.ehlo()
          server.starttls()
          server.ehlo()
          server.login(EMAIL_USER, EMAIL_PASS)
          server.send_message(email_msg)
          server.quit()
        
          print("Email sent successfully!")
          EOF
